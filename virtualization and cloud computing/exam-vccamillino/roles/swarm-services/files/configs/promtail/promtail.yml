server:
  http_listen_port: 9080
  register_instrumentation: true  # Enable metrics

positions:
  filename: /tmp/positions.yaml

client:
  url: http://loki:3100/loki/api/v1/push
  external_labels:
    hostname: ${HOSTNAME}

scrape_configs:
  - job_name: docker_containers
    pipeline_stages:
      - docker: {}
    docker_sd_configs: # https://grafana.com/docs/loki/latest/send-data/promtail/configuration/#docker_sd_configs
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.swarm.service.name"]
    relabel_configs:
      # Grab the container name
      - source_labels: [ '__meta_docker_container_name' ]
        target_label: container_name
        action: replace
      
      # Grab the service name from swarm labels
      - source_labels: [ '__meta_docker_container_label_com_docker_swarm_service_name' ]
        target_label: service_name
        action: replace
      
      # Grab the task name
      - source_labels: [ '__meta_docker_container_label_com_docker_swarm_task_name' ]
        target_label: task_name
        action: replace
      
      # Grab the node ID
      - source_labels: [ '__meta_docker_container_label_com_docker_swarm_node_id' ]
        target_label: node_id
        action: replace
      
      # Grab the stack name
      - source_labels: [ '__meta_docker_container_label_com_docker_stack_namespace' ]
        target_label: stack
        action: replace
      
      # Grab all existing container labels
      - regex: __meta_docker_container_label_(.+)
        replacement: container_label_$1
        action: labelmap
